let ratio=3/4,currentLatitude=null,currentLongitude=null,videoContainer=null,video=null,sourceCanvas=null,croppedCanvas=null,ctxSource=null,ctxCropped=null,videoWidth=320,videoHeight=426,width=320,height=426,shutter;function setDimension(e,t){croppedCanvas.width=e,croppedCanvas.style.width=e+"px",videoContainer.style.width=e+"px";let a=e/t;sourceCanvas.height=a;let o=videoHeight*t;sourceCanvas.width=o,sourceCanvas.style.width=o+"px",sourceCanvas.style.height=a+"px",croppedCanvas.style.height=a+"px",videoContainer.style.height=a+"px"}function detectGeolocation(e){navigator.geolocation?navigator.geolocation.getCurrentPosition(t=>{let a=t.coords.latitude,o=t.coords.longitude;null!=e&&e(a,o)},e=>{console.error("Error getting location:",e)}):console.log("Geolocation is not supported by this browser.")}function triggerDetectLocation(){document.querySelector("#captureButton").disabled=!0,document.querySelector("#clearButton").disabled=!0,document.querySelector("#uploadButton").disabled=!0,detectGeolocation(function(e,t){currentLatitude=e,currentLongitude=t,$.ajax({type:"GET",url:"lib.mobile-tools/ajax-alamat.php",data:{latitude:e,longitude:t},dataType:"json",success:function(a){document.querySelector('[name="alamat"]').value=JSON.stringify(a),document.querySelector('[name="latitude"]').value=e,document.querySelector('[name="longitude"]').value=t,document.querySelector("#captureButton").disabled=!1}})})}async function setupCamera(){let e=await navigator.mediaDevices.getUserMedia({video:!0});video.srcObject=e,video.onloadedmetadata=()=>{let e=height/video.videoHeight;videoWidth=video.videoWidth*e,videoHeight=video.videoHeight*e,video.width=videoWidth,video.height=videoHeight;let t=height*videoWidth/videoHeight;sourceCanvas.height=height,sourceCanvas.width=t,sourceCanvas.style.height=height+"px",sourceCanvas.style.width=t+"px",croppedCanvas.style.height=height+"px",videoContainer.style.height=height+"px",videoContainer.style.width=width+"px"}}document.addEventListener("DOMContentLoaded",function(){shutter=new Audio("lib.assets/sounds/camera.mp3"),videoContainer=document.getElementById("videoContainer"),video=document.getElementById("video"),sourceCanvas=document.getElementById("sourceCanvas"),croppedCanvas=document.getElementById("croppedCanvas"),ctxSource=sourceCanvas.getContext("2d"),ctxCropped=croppedCanvas.getContext("2d"),videoWidth=320,videoHeight=426,document.getElementById("captureButton").addEventListener("click",()=>{shutter.play(),ctxSource.drawImage(video,0,0,sourceCanvas.width,sourceCanvas.height);let e=sourceCanvas.width,t=sourceCanvas.height,a=t*ratio,o=t;croppedCanvas.width=a,croppedCanvas.height=o,ctxCropped.drawImage(sourceCanvas,(e-a)/2,(t-o)/2,a,o,0,0,croppedCanvas.width,croppedCanvas.height),document.querySelector("#clearButton").disabled=!1,document.querySelector("#uploadButton").disabled=!1}),document.getElementById("clearButton").addEventListener("click",()=>{ctxCropped.clearRect(0,0,croppedCanvas.width,croppedCanvas.height),document.querySelector("#clearButton").disabled=!0,document.querySelector("#uploadButton").disabled=!0}),document.querySelector('[name="jenis_kehadiran"]').addEventListener("change",function(e){"P"==e.target.value?document.querySelector('[name="aktivitas"]').style.display="block":document.querySelector('[name="aktivitas"]').style.display="none"}),document.getElementById("uploadButton").addEventListener("click",function(e){let t=$('[name="jenis_kehadiran"]').val(),a=$('[name="lokasi_id"]').val(),o=$('[name="aktivitas"]').val(),i=!0;return""==t?($('[name="jenis_kehadiran"]')[0].focus(),i=!1,e.preventDefault(),!1):""==a?($('[name="lokasi_id"]')[0].focus(),i=!1,e.preventDefault(),!1):"P"==t&&""==o?($('[name="aktivitas"]')[0].focus(),i=!1,e.preventDefault(),!1):!!confirm("Apakah Anda yakin akan mengirimkannya?")&&void(i&&croppedCanvas.toBlob(e=>{let t=new FormData($("#form-kehadiran")[0]);t.append("user_action","create"),t.append("file",e,"image.jpeg"),$("#progressContainer").show();let a=new XMLHttpRequest;a.upload.addEventListener("progress",e=>{if(e.lengthComputable){let t=e.loaded/e.total*100;$("#progressBar").val(t),$("#progressPercent").text(Math.round(t)+"%")}}),a.open("POST","kehadiran.php",!0),a.onload=()=>{200===a.status?window.location="kehadiran.php":alert("Failed to upload image.")},a.onerror=()=>{console.error("Error:",a.statusText),alert("Error uploading image.")},a.send(t)},"image/jpeg",.75))}),setupCamera(),triggerDetectLocation()});